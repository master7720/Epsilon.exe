name: NightlyBuild

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Check out repository
                uses: actions/checkout@v2

            -   name: Set up JDK
                uses: actions/setup-java@v1
                with:
                    java-version: 17

            -   name: Extra Gradle cache
                uses: actions/cache@v3
                with:
                    path: |
                        ~/.gradle/caches/forge_gradle
                    key: ${{ runner.os }}-extra-${{ hashFiles('~/.gradle/caches/forge_gradle') }}
                    restore-keys: |
                        ${{ runner.os }}-extra-

            -   name: Get version
                run: |
                    devVer=$(grep modVersion gradle.properties | grep -o '.\..\..')
                    commitHash=$(git rev-parse --short HEAD)
                    modVer=$devVer-nightly-$commitHash
                    echo modVer=$modVer >> $GITHUB_ENV

            -   name: Gradle assemble
                uses: burrunan/gradle-cache-action@v1
                env:
                    OVERRIDE_VERSION: ${{ env.modVer }}
                with:
                    concurrent: true
                    arguments: --build-cache assemble

            -   name: Copy jar
                env:
                    modVer: ${{ env.modVer }}
                run: |
                    cp build/libs/Epsilon-$modVer.jar Epsilon-$modVer.jar

            -   name: Upload jar
                uses: actions/upload-artifact@v2
                with:
                    name: nightly-build
                    path: Epsilon-${{ env.modVer }}.jar
